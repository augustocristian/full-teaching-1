def mvnHome
pipeline {

    stages{
            stage('Preparation') { // for display purposes
                // Get some code from a GitHub repository
                    git branch: 'DevelopmentOpenViduTests',
                                credentialsId: 'GitHub',
                                url: 'https://github.com/augustocristian/full-teaching-tunon-tests'

                // Get the Maven tool.
                // ** NOTE: This 'M3' Maven tool must be configured
                // **       in the global configuration.           
                mvnHome = tool 'M3.3.9'
                sutmediumip= "localhost"
            }      
            stage("OrchestrateTestCases"){
                    try {
                        parallel{

                            stage('LightTJob') {

                                stage('Deploy Light SUT') {
                                    sh 'cd docker/resources/light; ls .;docker-compose --no-ansi -p "FullTeachingLight" up -d'
                                    }
                                stage('Execute Light Tests') {
                                    // Run the maven build
                                    withEnv(["MVN_HOME=$mvnHome"]) {
                                        if (isUnix()) {
                                            sh ('cd e2e-test/no-Elastest/;ls .;"$MVN_HOME/bin/mvn" -Dapp.url=https://'+sutmediumip+':5003/ -Dtest=UserTest -B -DforkCount=0 test')
                                            } 
                                        else {
                                        // bat(/'cd e2e-test\no-Elastest\;dir .;"$MVN_HOME\bin\mvn" -Dapp.url=https://'+sutmediumip+':5003/ -Dtest=UserTest -B -DforkCount=0 test'/)
                                        }
                                    } 
                                }
                            }

                            stage('Medium TJOB') {
                                
                                stage('Start Medium SUT') {
                                    sh 'cd docker/resources/medium; ls .;docker-compose --no-ansi -p "FullTeachingMedium" up -d'
                                    }
                                stage('Execute Medium Tests') {
                                    // Run the maven build
                                    withEnv(["MVN_HOME=$mvnHome"]) {
                                        if (isUnix()) {
                                            sh ('cd e2e-test/no-Elastest/;ls .;"$MVN_HOME/bin/mvn" -Dapp.url=https://'+sutmediumip+':5003/ -Dtest=UserTest -B -DforkCount=0 test')
                                            } 
                                        else {
                                        // bat(/'cd e2e-test\no-Elastest\;dir .;"$MVN_HOME\bin\mvn" -Dapp.url=https://'+sutmediumip+':5003/ -Dtest=UserTest -B -DforkCount=0 test'/)
                                        }
                                    }
                                }
                            }
                            stage('Heavy TJOB') {
                                stage('Start Heavy SUT') {
                                    sh 'cd docker/resources/heavy; ls .;docker-compose --no-ansi -p "FullTeachingHeavy" up -d'
                                    }
                                
                                stage('Execute Medium Tests') {
                                    // Run the maven build
                                    withEnv(["MVN_HOME=$mvnHome"]) {
                                        if (isUnix()) {
                                            sh ('cd e2e-test/no-Elastest/;ls .;"$MVN_HOME/bin/mvn" -Dapp.url=https://'+sutmediumip+':5003/ -Dtest=UserTest -B -DforkCount=0 test')
                                            } 
                                        else {
                                        // bat(/'cd e2e-test\no-Elastest\;dir .;"$MVN_HOME\bin\mvn" -Dapp.url=https://'+sutmediumip+':5003/ -Dtest=UserTest -B -DforkCount=0 test'/)
                                        }
                                    }
                                
                                }
                            }
                        }
                    
                    } finally {

                        stage('Dispose Heavy'){
                                echo 'Stopping SUT Heavy'
                                sh 'cd docker/resources/heavy; ls .;docker-compose down'
                            }
                        stage('Dispose Medium'){
                                echo 'Stopping SUT Medium'
                                sh 'cd docker/resources/medium; ls .;docker-compose down'
                            }
                        stage('Dispose Light'){
                                echo 'Stopping SUT Light'
                                sh 'cd docker/resources/light; ls .;docker-compose down'
                            }
                        }
                }    
    
    
    stage('Results') {
        junit '**/target/surefire-reports/TEST-*.xml'
        archiveArtifacts 'target/*.jar'
    }


    }